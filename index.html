<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Static Shop — Product Page (Single file)</title>
  <style>
    :root{ --bg:#faf9fc; --card:#fff; --accent:#2b6cb0; --muted:#6b6b6b; --glass: rgba(0,0,0,0.06); --radius:12px; --maxw:1400px; --error:#b91c1c; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#111;font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, system-ui; -webkit-font-smoothing:antialiased}
    /* make wrap fluid to use viewport width nicely */
    .wrap{width:100%;max-width:none;margin:0 auto;padding:18px 28px;max-width:var(--maxw)}

    .menubar{display:flex;gap:18px;align-items:center;padding:10px 6px;background:#fff;border-radius:8px;border:1px solid #eef;margin-bottom:12px;flex-wrap:wrap}
    .menubar a{color:var(--muted);text-decoration:none;font-weight:600}
    .header{background:linear-gradient(180deg,#fff,transparent);padding:14px;border-radius:8px;margin-bottom:12px}
    .header h1{margin:0;font-size:18px}
    .sub{color:var(--muted);margin-top:6px}

    .filter-row{display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;background:#fff;border:1px solid #eee;color:var(--muted);cursor:pointer;font-weight:600}
    .chip.active{background:var(--accent);color:#fff;border-color:transparent}

    /* grid responsive and fluid */
    .grid{display:grid;gap:20px; grid-template-columns: repeat(3, 1fr); width:100%;}
    @media (max-width:1000px){ .grid{grid-template-columns: repeat(2,1fr);} }
    @media (max-width:600px){ .grid{grid-template-columns: 1fr;} }

    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 8px 20px var(--glass);display:flex;flex-direction:column;align-items:center;gap:8px}
    .thumb{width:100%;max-width:280px;height:220px;border-radius:8px;background:#fff;border:2px dashed #e6e6e6;display:flex;align-items:center;justify-content:center;color:#bdbdbd;font-weight:600}
    .pname{font-weight:700;margin-top:6px;text-align:center}
    .pinfo{font-size:13px;color:var(--muted);text-align:center}
    .controls{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap;justify-content:center}
    .btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer;font-weight:600}
    .btn.ghost{background:#fff;border:1px solid #ddd;color:var(--muted)}
    .qty{display:flex;align-items:center;gap:6px}
    .qty .qbtn{padding:6px 9px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .qty .count{min-width:26px;text-align:center;font-weight:700}
    .remove-btn{background:#fff;border:1px solid #f44336;color:#f44336;padding:6px 8px;border-radius:6px;cursor:pointer}

    .cart-float{position:fixed;right:18px;bottom:18px;background:linear-gradient(180deg,#fff,#f7fbff);padding:10px;border-radius:28px;box-shadow:0 12px 30px rgba(0,0,0,0.12);cursor:pointer;display:flex;align-items:center;gap:10px;z-index:60}
    .cart-count{background:var(--accent);color:#fff;padding:6px 8px;border-radius:999px;font-weight:700}

    /* overlay and modals */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center;z-index:120;padding:18px}
    .overlay.show{display:flex}
    .modal{background:var(--card);border-radius:10px;padding:18px;max-width:980px;width:100%;max-height:88vh;overflow:auto;position:relative;box-shadow:0 20px 60px rgba(0,0,0,0.18)}
    .modal .close{position:absolute;right:12px;top:8px;border:0;background:none;font-size:20px;cursor:pointer}
    .modal h2{margin-top:0;text-align:center}
    /* product modal bigger but responsive */
    .product-modal{width:100%;max-width:1200px;height:80vh;display:flex;gap:18px;padding:18px;box-sizing:border-box}
    .product-modal .left{flex:1;display:flex;align-items:center;justify-content:center}
    .product-modal .right{flex:1;display:flex;flex-direction:column;gap:10px}
    .cart-list{max-height:56vh;overflow:auto;padding-right:8px}
    .cart-list::-webkit-scrollbar{width:8px}
    .cart-list::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:8px}
    .cart-list{scrollbar-width:thin;scrollbar-color:#d1d5db transparent}

    .form-row{display:flex;gap:12px;margin-bottom:6px;flex-wrap:wrap}
    .field{flex:1;min-width:220px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px;font-weight:700}
    .rule{font-size:12px;color:#555;margin-bottom:6px}
    input[type=text],textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #e5e7eb;font-size:14px;transition:border-color .12s, box-shadow .12s, background .12s}
    input.invalid, textarea.invalid{border-color:var(--error);background:#fff6f6;box-shadow:0 0 0 3px rgba(185,28,28,0.06)}

    /* inline error style (Times New Roman, bold, red, spaced) */
    .field-error{display:none;margin-top:6px;color:var(--error);font-family:'Times New Roman', Times, serif;font-weight:700;font-size:12px;letter-spacing:0.03em;word-spacing:0.08em;display:flex;align-items:center;gap:8px}
    .field-error svg{width:18px;height:18px;flex:0 0 18px}

    .small-popup{background:#fff;padding:18px;border:2px solid #222;border-radius:6px;min-width:300px;text-align:center}
    footer{margin-top:26px;text-align:center;color:var(--muted);font-size:13px;padding-bottom:30px}

    .screen-refresh{position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;transition:opacity .35s ease;z-index:250}
    .screen-refresh.show{opacity:1;pointer-events:auto}

    /* failure popup */
    .failed-popup{background:#fff;padding:18px;border:2px solid var(--error);border-radius:8px;min-width:320px;text-align:center;box-shadow:0 12px 30px rgba(0,0,0,0.12)}
    .failed-actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .btn.ghost{background:#fff;color:var(--muted);border:1px solid #e5e7eb}

    /* lock scroll helper */
    body.no-scroll{overflow:hidden;height:100vh}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="menubar"><a href="#">Home</a><a href="#">Products</a><a href="#">About</a><a href="#">Contact</a></div>
    <div class="header"><h1>Product Catalog</h1><div class="sub">Select items and place an order. We will contact you to confirm — no prices on site.</div></div>

    <div class="filter-row">
      <div class="filter-icon" title="Filters">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#374151" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M6 12h12M10 18h4"/></svg>
      </div>
      <div class="chip active" data-filter="all">All Products</div>
      <div class="chip" data-filter="Cleaning Chemicals">Cleaning Chemicals</div>
      <div class="chip" data-filter="Cleaning Equipment">Cleaning Equipments</div>
    </div>

    <main>
      <section class="grid" id="grid"></section>
    </main>

    <footer>© <span id="year"></span> Surprise Shop — demo. All self-contained.</footer>
  </div>

  <div class="cart-float" id="cartFloat" aria-hidden="false">
    <div style="display:flex;align-items:center;gap:8px">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="9" cy="20" r="1"></circle>
        <circle cx="20" cy="20" r="1"></circle>
        <path d="M1 1h4l2.6 12.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
      </svg>
      <div style="font-weight:700">Your Cart</div>
    </div>
    <div class="cart-count" id="cartCount">0</div>
  </div>

  <iframe name="hidden_iframe" style="display:none"></iframe>

  <!-- CART Modal -->
  <div class="overlay" id="cartModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:980px;">
      <button class="close" id="closeCartModal" aria-label="Close">✕</button>
      <h2>Your Cart</h2>
      <div class="cart-list" id="cartList"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;flex-wrap:wrap">
        <div style="color:var(--muted)">Review items before ordering</div>
        <div>
          <!-- two explicit buttons -->
          <button class="btn" id="cartOrderMail" title="Order with Mail">Order with Mail</button>
          <button class="btn ghost" id="cartOrderWA" title="Order with WhatsApp" style="margin-left:8px">Order with WhatsApp</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PRODUCT Info Modal (~80%) -->
  <div class="overlay" id="productModal" aria-hidden="true">
    <div class="modal product-modal" role="dialog" aria-modal="true">
      <button class="close" id="closeProductModal" aria-label="Close">✕</button>
      <div class="left">
        <div style="width:80%;height:80%;border-radius:8px;background:#fff;border:2px dashed #e6e6e6;display:flex;align-items:center;justify-content:center;color:#bdbdbd">Image</div>
      </div>
      <div class="right">
        <h2 id="pTitle">Product Name</h2>
        <div id="pCategory" style="color:var(--muted)"></div>
        <p id="pDesc" style="color:var(--muted);line-height:1.4">Product description placeholder.</p>
        <div style="margin-top:auto;display:flex;gap:8px;align-items:center;">
          <div class="qty" id="pQtyArea" style="display:none;">
            <button class="qbtn" id="pMinus">−</button>
            <div class="count" id="pCount">1</div>
            <button class="qbtn" id="pPlus">+</button>
          </div>
          <button class="btn" id="pAddInitial">Add to Cart</button>
          <button class="remove-btn" id="pRemove" style="display:none">Remove</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CHECKOUT Modal -->
  <div class="overlay" id="checkoutModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:720px;">
      <button class="close" id="closeCheckoutModal" aria-label="Close">✕</button>
      <h2>Your Contact Details</h2>
      <!-- show which mode was chosen -->
      <div id="chosenModeLabel" style="text-align:center;color:var(--muted);margin-bottom:8px;font-weight:600"></div>

      <form id="checkoutForm" novalidate>
        <div class="form-row">
          <div class="field">
            <label>Name *</label>
            <div class="rule">Use letters and spaces only — 2 to 60 characters</div>
            <input type="text" name="name" autocomplete="name" required>
            <div class="field-error" id="err-name">
              <svg viewBox="0 0 24 24" fill="none" stroke="#b91c1c" stroke-width="2"><path d="M12 9v4" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="16" r="1"/></svg>
              <div id="err-name-txt">Only letters and spaces (2-60 chars).</div>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Contact Number *</label>
            <div class="rule">Digits only — 6 to 15 digits</div>
            <input type="text" name="phone" inputmode="numeric" autocomplete="tel" required>
            <div class="field-error" id="err-phone">
              <svg viewBox="0 0 24 24" fill="none" stroke="#b91c1c" stroke-width="2"><path d="M12 9v4" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="16" r="1"/></svg>
              <div id="err-phone-txt">Digits only — 6 to 15 digits.</div>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Address *</label>
            <div class="rule">Enter a delivery address</div>
            <textarea name="address" rows="2" required></textarea>
            <div class="field-error" id="err-address">
              <svg viewBox="0 0 24 24" fill="none" stroke="#b91c1c" stroke-width="2"><path d="M12 9v4" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="16" r="1"/></svg>
              <div id="err-address-txt">Please provide an address (min 4 chars).</div>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Email</label>
            <div class="rule">Optional — must be a valid email like name@domain.com</div>
            <input type="text" name="email" autocomplete="email">
            <div class="field-error" id="err-email">
              <svg viewBox="0 0 24 24" fill="none" stroke="#b91c1c" stroke-width="2"><path d="M12 9v4" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="16" r="1"/></svg>
              <div id="err-email-txt">Must be a valid email (example@mail.com).</div>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Company Name, If Applicable</label>
            <div class="rule">Optional — letters, numbers and spaces allowed</div>
            <input type="text" name="company" autocomplete="organization">
          </div>
        </div>

        <div style="display:flex;gap:8px;justify-content:center;margin-top:6px">
          <button type="button" class="btn" id="backToCart">Back</button>
          <button type="submit" class="btn" id="submitOrderBtn">Submit Order</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ORDER RECEIVED Popup -->
  <div class="overlay" id="receivedModal" aria-hidden="true">
    <div class="small-popup" role="dialog" aria-modal="true">
      <button class="close" id="closeReceivedModal" aria-label="Close">✕</button>
      <h3>Your Order has been Received</h3>
      <p style="margin-top:6px;color:var(--muted)">Within next 5 working hours, our team will contact you for order confirmation.<br><strong>Thank you!</strong></p>
    </div>
  </div>

  <!-- FAILURE Popup (timeout) -->
  <div class="overlay" id="failedModal" aria-hidden="true">
    <div class="failed-popup" role="dialog" aria-modal="true">
      <button class="close" id="closeFailedModal" aria-label="Close">✕</button>
      <h3 style="color:var(--error)">Order not confirmed</h3>
      <p id="failedMsg" style="color:#000;margin-top:6px">We didn't detect a completed send (timeout). You can continue shopping with your cart preserved, or start fresh and clear the cart.</p>
      <div class="failed-actions">
        <button class="btn ghost" id="continueShopping">Continue Shopping</button>
        <button class="btn" id="startFresh">Start Fresh</button>
      </div>
    </div>
  </div>

  <div class="screen-refresh" id="refreshOverlay"></div>

<script>
  /* CONFIG placeholders - replace with your Apps Script exec URL & secret if needed */
  const CONFIG = { APPS_SCRIPT_URL: 'REPLACE_WITH_APPS_SCRIPT_URL', SHARED_SECRET: 'REPLACE_WITH_SECRET' };

  /* Sample products */
  const PRODUCTS = [
    { id:1, name:'Product 1', category:'Cleaning Chemicals', tags:['liquid','concentrate'], desc:'High-quality cleaning concentrate for floors.' },
    { id:2, name:'Product 2', category:'Cleaning Chemicals', tags:['powder'], desc:'Powdered detergent for heavy stains.' },
    { id:3, name:'Product 3', category:'Cleaning Equipment', tags:['sprayer'], desc:'Handheld sprayer for small areas.' },
    { id:4, name:'Product 4', category:'Cleaning Equipment', tags:['brush'], desc:'Durable scrub brush for tough dirt.' },
    { id:5, name:'Product 5', category:'Cleaning Chemicals', tags:['disinfectant'], desc:'Hospital-grade disinfectant.' },
    { id:6, name:'Product 6', category:'Cleaning Equipment', tags:['machine'], desc:'Floor cleaning machine (compact).' }
  ];

  /* state */
  const state = { cart: {}, currentProduct: null };
  let orderMode = 'mail'; // 'mail' or 'whatsapp'
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // render year
  $('#year').textContent = new Date().getFullYear();

  /* Helper: normalize input (trim + remove zero-width/BOM) */
  function normalize(v){ return String(v||'').replace(/\u200B|\uFEFF/g,'').trim(); }

  // Validation helpers
  function validName(n) { const v = normalize(n); return /^[A-Za-z\s]{2,60}$/.test(v); }
  function validPhone(p) { const v = normalize(p).replace(/[^0-9]/g,''); return /^[0-9]{6,15}$/.test(v); }
  function validAddress(a) { return normalize(a).length >= 4; }
  function validEmail(e) { const v = normalize(e); if(v === '') return true; return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

  // get inputs & state for touched fields
  const nameInput = document.querySelector('input[name="name"]');
  const phoneInput = document.querySelector('input[name="phone"]');
  const addressInput = document.querySelector('textarea[name="address"]');
  const emailInput = document.querySelector('input[name="email"]');
  const submitBtn = document.getElementById('submitOrderBtn');
  const chosenModeLabel = document.getElementById('chosenModeLabel');

  // track touched status (so errors appear only after user interacted)
  const touched = { name:false, phone:false, address:false, email:false };

  function showError(id,msg){
    const el = document.getElementById(id); if(!el) return;
    const txt = el.querySelector('div'); if(msg && txt) txt.textContent = msg;
    el.style.display = 'flex';
  }
  function hideError(id){ const el = document.getElementById(id); if(!el) return; el.style.display = 'none'; }

  // togglers: only show error when touched and invalid
  function checkAndToggle(input, nameKey, validator, errId, msg){
    const val = input.value || '';
    const ok = validator(val);
    if(touched[nameKey]){
      if(!ok){ input.classList.add('invalid'); showError(errId, msg); }
      else { input.classList.remove('invalid'); hideError(errId); }
    } else {
      // not touched: hide error and remove invalid mark
      input.classList.remove('invalid'); hideError(errId);
    }
  }

  // mark touched on first input/blur
  function onFirstTouch(key){ if(!touched[key]) touched[key]=true; }

  nameInput.addEventListener('input', ()=>{ onFirstTouch('name'); checkAndToggle(nameInput,'name',validName,'err-name','Only letters and spaces (2-60 chars).'); toggleSubmitState(); });
  nameInput.addEventListener('blur', ()=>{ onFirstTouch('name'); checkAndToggle(nameInput,'name',validName,'err-name','Only letters and spaces (2-60 chars).'); toggleSubmitState(); });

  phoneInput.addEventListener('input', ()=>{ onFirstTouch('phone'); // strip non-digits for UX
    const cleaned = normalize(phoneInput.value).replace(/[^0-9]/g,'');
    if(phoneInput.value !== cleaned) phoneInput.value = cleaned;
    checkAndToggle(phoneInput,'phone',validPhone,'err-phone','Digits only — 6 to 15 digits.');
    toggleSubmitState();
  });
  phoneInput.addEventListener('blur', ()=>{ onFirstTouch('phone'); checkAndToggle(phoneInput,'phone',validPhone,'err-phone','Digits only — 6 to 15 digits.'); toggleSubmitState(); });

  addressInput.addEventListener('input', ()=>{ onFirstTouch('address'); checkAndToggle(addressInput,'address',validAddress,'err-address','Please provide an address (min 4 chars).'); toggleSubmitState(); });
  addressInput.addEventListener('blur', ()=>{ onFirstTouch('address'); checkAndToggle(addressInput,'address',validAddress,'err-address','Please provide an address (min 4 chars).'); toggleSubmitState(); });

  emailInput.addEventListener('input', ()=>{ onFirstTouch('email'); const v = normalize(emailInput.value); if(v===''){ emailInput.classList.remove('invalid'); hideError('err-email'); } else { checkAndToggle(emailInput,'email',validEmail,'err-email','Must be a valid email (example@mail.com).'); } toggleSubmitState(); });
  emailInput.addEventListener('blur', ()=>{ onFirstTouch('email'); const v = normalize(emailInput.value); if(v===''){ emailInput.classList.remove('invalid'); hideError('err-email'); } else { checkAndToggle(emailInput,'email',validEmail,'err-email','Must be a valid email (example@mail.com).'); } toggleSubmitState(); });

  function toggleSubmitState(){
    const nameOk = validName(nameInput.value);
    const phoneOk = validPhone(phoneInput.value);
    const addrOk = validAddress(addressInput.value);
    const emailVal = normalize(emailInput.value);
    const emailOk = (emailVal === '') || validEmail(emailVal);
    submitBtn.disabled = !(nameOk && phoneOk && addrOk && emailOk);
    submitBtn.style.opacity = submitBtn.disabled ? 0.6 : 1;
  }
  toggleSubmitState();

  /* overlay helpers - show/hide and lock body scroll when any overlay visible */
  function showOverlay(selector){
    const el = $(selector);
    if(!el) return;
    el.classList.add('show');
    el.setAttribute('aria-hidden','false');
    lockBodyScrollIfNeeded();
  }
  function hideOverlay(selector){
    const el = $(selector);
    if(!el) return;
    el.classList.remove('show');
    el.setAttribute('aria-hidden','true');
    lockBodyScrollIfNeeded();
  }
  function lockBodyScrollIfNeeded(){
    // if any overlay has .show then lock; otherwise unlock
    const any = Array.from(document.querySelectorAll('.overlay')).some(o => o.classList.contains('show'));
    if(any) document.documentElement.classList.add('no-scroll'), document.body.classList.add('no-scroll');
    else document.documentElement.classList.remove('no-scroll'), document.body.classList.remove('no-scroll');
  }

  /* openExternalAndWait - same robust behavior: open window, detect closed or visibility return, timeout, or blocked */
  function openExternalAndWait(url, onSuccess, onFailure, timeout = 120000){
    let win = null;
    try { win = window.open(url, '_blank'); } catch(e) { win = null; }
    if (!win) {
      return setTimeout(()=> onFailure('blocked'), 250);
    }
    const start = Date.now(); let finished = false;
    function cleanup(){ finished = true; clearInterval(interval); document.removeEventListener('visibilitychange', visibilityHandler); }
    function visibilityHandler(){ if(document.visibilityState === 'visible' && Date.now() - start > 500){ cleanup(); try{ if(win && !win.closed) win.close(); }catch(e){} onSuccess('visibility'); } }
    function check(){
      if(finished) return;
      try {
        if(win && win.closed){ cleanup(); onSuccess('closed'); return; }
      } catch(e){}
      if(Date.now() - start > timeout){ cleanup(); onFailure('timeout'); }
    }
    document.addEventListener('visibilitychange', visibilityHandler);
    const interval = setInterval(check, 600);
  }

  /* build order body */
  function buildOrderText(formData){
    const items = Object.keys(state.cart).map(id => {
      const p = PRODUCTS.find(x => x.id == id);
      return `${p ? p.name : 'Item '+id} — qty: ${state.cart[id]}`;
    });
    const itemsText = items.length ? items.join('\n') : '(no items)';
    const lines = [
      'New order from website:',
      '',
      'Items:',
      itemsText,
      '',
      'Customer details:',
      `Name: ${normalize(formData.name)}`,
      `Phone: ${normalize(formData.phone)}`,
      `Address: ${normalize(formData.address)}`,
      `Email: ${normalize(formData.email) || '-'}`,
      `Company: ${normalize(formData.company) || '-'}`,
      '',
      `Placed: ${new Date().toLocaleString()}`
    ];
    return lines.join('\n');
  }

  /* Wire cart order buttons to open checkout in appropriate mode */
  $('#cartOrderMail').addEventListener('click', () => {
    if (Object.keys(state.cart).length === 0) { alert('Cart empty. Please add products.'); return; }
    orderMode = 'mail';
    $('#chosenModeLabel').textContent = 'Ordering via Mail';
    showOverlay('#checkoutModal');
    // reset touched so errors don't show unless they interact
    Object.keys(touched).forEach(k=>touched[k]=false);
    ['err-name','err-phone','err-address','err-email'].forEach(id=>hideError(id));
    [nameInput, phoneInput, addressInput, emailInput].forEach(i=>i.classList.remove('invalid'));
    toggleSubmitState();
  });

  $('#cartOrderWA').addEventListener('click', () => {
    if (Object.keys(state.cart).length === 0) { alert('Cart empty. Please add products.'); return; }
    orderMode = 'whatsapp';
    $('#chosenModeLabel').textContent = 'Ordering via WhatsApp';
    showOverlay('#checkoutModal');
    Object.keys(touched).forEach(k=>touched[k]=false);
    ['err-name','err-phone','err-address','err-email'].forEach(id=>hideError(id));
    [nameInput, phoneInput, addressInput, emailInput].forEach(i=>i.classList.remove('invalid'));
    toggleSubmitState();
  });

  // modal open/close wiring (use showOverlay/hideOverlay to maintain scroll lock)
  $$('.close').forEach(b => b.addEventListener('click', () => {
    const o = b.closest('.overlay');
    if (o) hideOverlay('#' + o.id);
  }));
  // cart float open
  $('#cartFloat').addEventListener('click', () => { renderCartList(); showOverlay('#cartModal'); });
  $('#closeCartModal').addEventListener('click', () => hideOverlay('#cartModal'));

  $('#closeProductModal').addEventListener('click', () => hideOverlay('#productModal'));
  $('#closeCheckoutModal').addEventListener('click', () => hideOverlay('#checkoutModal'));
  $('#closeReceivedModal').addEventListener('click', () => hideOverlay('#receivedModal'));
  $('#closeFailedModal').addEventListener('click', () => hideOverlay('#failedModal'));

  $('#backToCart').addEventListener('click', () => { hideOverlay('#checkoutModal'); showOverlay('#cartModal'); });

  // initial render
  function renderGrid(list) {
    const grid = $('#grid'); grid.innerHTML = '';
    list.forEach(p => {
      const card = document.createElement('div'); card.className = 'card';
      const thumb = document.createElement('div'); thumb.className = 'thumb'; thumb.textContent = 'Image';
      const name = document.createElement('div'); name.className = 'pname'; name.textContent = p.name;
      const info = document.createElement('div'); info.className = 'pinfo'; info.textContent = p.category + (p.tags ? ' • ' + p.tags.join(', ') : '');
      const controls = document.createElement('div'); controls.className = 'controls';

      const infoBtn = document.createElement('button'); infoBtn.className = 'btn ghost'; infoBtn.textContent = 'Product Info';
      infoBtn.onclick = () => openProductModal(p);

      const addBtn = document.createElement('button'); addBtn.className = 'btn'; addBtn.textContent = 'Add to Cart';
      addBtn.onclick = () => {
        state.cart[p.id] = (state.cart[p.id] || 0) + 1;
        renderGrid(currentFilteredProducts()); updateCartCount();
      };

      controls.appendChild(infoBtn); controls.appendChild(addBtn);

      if (state.cart[p.id]) {
        const qty = document.createElement('div'); qty.className = 'qty';
        const minus = document.createElement('button'); minus.className = 'qbtn'; minus.textContent = '−';
        const count = document.createElement('div'); count.className = 'count'; count.textContent = state.cart[p.id];
        const plus = document.createElement('button'); plus.className = 'qbtn'; plus.textContent = '+';

        minus.onclick = () => { const cur = state.cart[p.id] || 1; const next = Math.max(1, cur - 1); state.cart[p.id] = next; count.textContent = next; updateCartCount(); renderGrid(currentFilteredProducts()); };
        plus.onclick = () => { const cur = state.cart[p.id] || 0; state.cart[p.id] = cur + 1; count.textContent = state.cart[p.id]; updateCartCount(); renderGrid(currentFilteredProducts()); };

        qty.appendChild(minus); qty.appendChild(count); qty.appendChild(plus);
        controls.appendChild(qty);

        const remove = document.createElement('button'); remove.className = 'remove-btn'; remove.textContent = 'Remove';
        remove.onclick = () => { delete state.cart[p.id]; renderGrid(currentFilteredProducts()); updateCartCount(); };
        controls.appendChild(remove);
      }

      card.appendChild(thumb); card.appendChild(name); card.appendChild(info); card.appendChild(controls);
      grid.appendChild(card);
    });
  }

  /* chips single-select */
  $$('.chip').forEach(ch => ch.addEventListener('click', () => {
    $$('.chip').forEach(c => c.classList.remove('active'));
    ch.classList.add('active');
    renderGrid(currentFilteredProducts());
  }));

  function currentFilteredProducts() {
    const active = $$('.chip.active')[0];
    if (!active) return PRODUCTS;
    const f = active.getAttribute('data-filter');
    if (f === 'all' || f.toLowerCase() === 'all products') return PRODUCTS;
    return PRODUCTS.filter(p => p.category === f);
  }

  function updateCartCount() { const total = Object.values(state.cart).reduce((s, n) => s + n, 0); $('#cartCount').textContent = total; }

  /* cart modal rendering */
  function renderCartList() {
    const list = $('#cartList'); list.innerHTML = '';
    const items = Object.keys(state.cart).map(id => ({ id: +id, qty: state.cart[id] }));
    if (items.length === 0) { list.innerHTML = '<div style="padding:22px;text-align:center;color:var(--muted)">Cart is empty. Add products from the list.</div>'; return; }
    items.forEach((it, idx) => {
      const p = PRODUCTS.find(x => x.id === it.id);
      const row = document.createElement('div'); row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.justifyContent = 'space-between'; row.style.padding = '10px 0';
      const left = document.createElement('div'); left.style.display = 'flex'; left.style.alignItems = 'center'; left.style.gap = '12px';
      const img = document.createElement('div'); img.style.width = '64px'; img.style.height = '64px'; img.style.border = '1px solid #eee'; img.style.display = 'flex'; img.style.alignItems = 'center'; img.style.justifyContent = 'center'; img.textContent = 'Img';
      const nm = document.createElement('div'); nm.innerHTML = `<div style="font-weight:700">${idx+1}. ${p.name}</div><div style="color:var(--muted);font-size:13px">${p.category}</div>`;
      left.appendChild(img); left.appendChild(nm);
      const qty = document.createElement('div'); qty.style.minWidth = '80px'; qty.style.textAlign = 'center'; qty.innerHTML = `<div style="font-weight:700">${it.qty}</div>`;
      row.appendChild(left); row.appendChild(qty); list.appendChild(row);
    });
  }

  /* product modal functions */
  function openProductModal(p) {
    state.currentProduct = p;
    $('#pTitle').textContent = p.name;
    $('#pCategory').textContent = p.category + (p.tags ? ' • ' + p.tags.join(', ') : '');
    $('#pDesc').textContent = p.desc || 'No description';
    const qArea = $('#pQtyArea');
    qArea.style.display = state.cart[p.id] ? 'flex' : 'none';
    $('#pCount').textContent = state.cart[p.id] || 1;
    $('#pRemove').style.display = state.cart[p.id] ? 'inline-block' : 'none';
    $('#pAddInitial').style.display = state.cart[p.id] ? 'none' : 'inline-block';
    showOverlay('#productModal');
  }

  // product modal interactions
  $('#pPlus').addEventListener('click', () => { const p = state.currentProduct; if (!p) return; state.cart[p.id] = (state.cart[p.id] || 0) + 1; $('#pCount').textContent = state.cart[p.id]; updateCartCount(); renderGrid(currentFilteredProducts()); });
  $('#pMinus').addEventListener('click', () => { const p = state.currentProduct; if (!p) return; const cur = state.cart[p.id] || 1; const next = Math.max(1, cur - 1); state.cart[p.id] = next; $('#pCount').textContent = next; updateCartCount(); renderGrid(currentFilteredProducts()); });
  $('#pAddInitial').addEventListener('click', () => { const p = state.currentProduct; if (!p) return; state.cart[p.id] = 1; $('#pAddInitial').style.display = 'none'; $('#pQtyArea').style.display = 'flex'; $('#pRemove').style.display = 'inline-block'; updateCartCount(); renderGrid(currentFilteredProducts()); });
  $('#pRemove').addEventListener('click', () => { const p = state.currentProduct; if (!p) return; delete state.cart[p.id]; hideOverlay('#productModal'); updateCartCount(); renderGrid(currentFilteredProducts()); });

  // Checkout submit: open mailto or wa depending on orderMode and wait
  $('#checkoutForm').addEventListener('submit', function (e) {
    e.preventDefault();
    // final validation (mark touched so errors show)
    touched.name = touched.phone = touched.address = touched.email = true;
    checkAndToggle(nameInput,'name',validName,'err-name','Only letters and spaces (2-60 chars).');
    checkAndToggle(phoneInput,'phone',validPhone,'err-phone','Digits only — 6 to 15 digits.');
    checkAndToggle(addressInput,'address',validAddress,'err-address','Please provide an address (min 4 chars).');
    const emailVal = normalize(emailInput.value);
    if(emailVal === '') hideError('err-email');
    else checkAndToggle(emailInput,'email',validEmail,'err-email','Must be a valid email (example@mail.com).');
    toggleSubmitState();
    if(!validName(nameInput.value) || !validPhone(phoneInput.value) || !validAddress(addressInput.value) || (emailVal && !validEmail(emailVal))) {
      // bail if invalid
      return;
    }

    // gather form data
    const fd = new FormData(e.target); const data = Object.fromEntries(fd.entries());
    data.items = JSON.stringify(Object.keys(state.cart).map(id => { const p = PRODUCTS.find(x => x.id == id); return { id: p ? p.id : id, name: p ? p.name : ('Item '+id), qty: state.cart[id] }; }));

    const bodyText = buildOrderText(data);
    const encodedBody = encodeURIComponent(bodyText);

    let urlToOpen;
    if (orderMode === 'mail') {
      const to = 'mrineshassociates@gmail.com';
      const subject = `New order from website — ${normalize(data.name) || 'New'} `;
      urlToOpen = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodedBody}`;
    } else {
      const WHATSAPP_NUMBER = '8111030003'; // <-- REPLACE with your number (digits only)
urlToOpen = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(bodyText)}`;
    }

    // snapshot
    const cartSnapshot = JSON.parse(JSON.stringify(state.cart));

    // close checkout modal (cart kept)
    hideOverlay('#checkoutModal');

    // show refresh overlay
    const overlay = $('#refreshOverlay'); overlay.classList.add('show');

    openExternalAndWait(urlToOpen,
      (reason) => {
        overlay.classList.remove('show');
        // success: clear cart & reset
        state.cart = {}; state.currentProduct = null;
        renderGrid(PRODUCTS); updateCartCount();
        $$('.overlay').forEach(o => hideOverlay('#' + o.id));
        showOverlay('#receivedModal');
        document.getElementById('checkoutForm').reset();
        Object.keys(touched).forEach(k=>touched[k]=false);
        [nameInput, phoneInput, addressInput, emailInput].forEach(x => x.classList.remove('invalid'));
        ['err-name','err-phone','err-address','err-email'].forEach(id => hideError(id));
        toggleSubmitState();
      },
      (why) => {
        overlay.classList.remove('show');
        // failure: preserve cart; show failed modal
        showOverlay('#failedModal');
        $('#continueShopping').onclick = () => { hideOverlay('#failedModal'); showOverlay('#cartModal'); };
        $('#startFresh').onclick = () => {
          state.cart = {}; renderGrid(PRODUCTS); updateCartCount();
          hideOverlay('#failedModal');
          document.getElementById('checkoutForm').reset();
          Object.keys(touched).forEach(k=>touched[k]=false);
          [nameInput, phoneInput, addressInput, emailInput].forEach(x => x.classList.remove('invalid'));
          ['err-name','err-phone','err-address','err-email'].forEach(id => hideError(id));
          toggleSubmitState();
        };
      },
      120000
    );
  });

  // postToAppsScript preserved (unused unless you configure CONFIG)
  function postToAppsScript(data) {
    if (!CONFIG.APPS_SCRIPT_URL || CONFIG.APPS_SCRIPT_URL.includes('REPLACE')) { console.warn('Apps Script URL not configured; skipping POST.'); return; }
    const f = document.createElement('form'); f.method = 'POST'; f.action = CONFIG.APPS_SCRIPT_URL; f.target = 'hidden_iframe';
    const s = document.createElement('input'); s.type = 'hidden'; s.name = 'secret'; s.value = CONFIG.SHARED_SECRET; f.appendChild(s);
    ['name', 'phone', 'address', 'email', 'company'].forEach(k => { const i = document.createElement('input'); i.type = 'hidden'; i.name = k; i.value = data[k] || ''; f.appendChild(i); });
    const itemsI = document.createElement('input'); itemsI.type = 'hidden'; itemsI.name = 'items'; itemsI.value = data.items || ''; f.appendChild(itemsI);
    document.body.appendChild(f); f.submit(); document.body.removeChild(f);
  }

  // render functions already declared earlier; final initial render:
  renderGrid(PRODUCTS); updateCartCount();

  // ensure body scroll state is synced at load
  lockBodyScrollIfNeeded();

  // Accessibility niceties: close overlays on Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      $$('.overlay.show').forEach(o => hideOverlay('#' + o.id));
    }
  });
</script>
</body>
</html>

